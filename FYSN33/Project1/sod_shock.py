import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import solve_ivp
from matplotlib.animation import FuncAnimation, FFMpegWriter

import main


# ============== build the initial geometry: ===============

# left region
Nx_L = 320
dx_L = 0.001875
x_L = -dx_L * np.arange(Nx_L-1,-1,-1) # arange magic

# right region
Nx_R = 80
dx_R = 0.0075
x_R = dx_R * np.arange(1, Nx_R+1)

x = np.concatenate([x_L,x_R])
N = len(x)

# SPHsys setup
kernel = main.cubicSplineKernel(h=0.01) # calculate h later, see slides
system = main.SPHsystem(N, kernel)

# initialize statevector
system.m[:] = 0.001875

system.S[:,0] = x   # position
system.S[:,1] = 0.0 # velocity (v_R = v_L = 0)
system.density_summation()  # depends on spacing
system.S[x<=0, 3] = 2.5 # left region energy
system.S[x>0, 3] = 1.795 # right region energy


# ============================= solver =============================
t0 = 0.0
dt = 0.005
Nsteps = 40

times = np.linspace(0,dt*Nsteps,Nsteps) # should be 40 time steps (to reproduce slides)

S0 = system.S.flatten()   # flatten S -> [x1, v1, rho1, e1, x2, v2,...]
NS = main.NavierStokes1D()

sol = solve_ivp(
    fun=lambda t, y: main.RHS(t, y, system, NS),
    t_span=(t0, dt*Nsteps),
    y0=S0,
    t_eval=times,
    method="RK45",
    max_step=dt,
    rtol=1e-4,
    atol=1e-7
)

# ========================== static plots =======================
k = -1  # last (40:th) time step
S_flat_k = sol.y[:,k]

S_k = S_flat_k.reshape(N,4)
system.S[:] = S_k
system.density_summation()

x_k = system.x
v_k = system.v
rho_k = system.rho
e_k = system.e
P_k = system.pressure()

plt.plot(x_k, rho_k)
plt.xlim((-0.4,0.4))
plt.xlabel("x [m]")
plt.ylabel("Density [kg/m³]")
plt.grid()
plt.show()

plt.plot(x_k, P_k)
plt.xlim((-0.4,0.4))
plt.xlabel("x [m]")
plt.ylabel("Pressure [N/m²]")
plt.show()

plt.plot(x_k, v_k)
plt.xlabel("x [m]")
plt.ylabel("Velocity [m/s]")
plt.xlim((-0.4,0.4))
plt.show()



#===================== Sod shock simulation =======================
fig, axs = plt.subplots(4,1,figsize=(8,8))
(ax_v, ax_rho, ax_p, ax_e) = axs

scat_v   = ax_v.scatter([], [], s=12)
scat_rho = ax_rho.scatter([], [], s=12)
scat_p   = ax_p.scatter([], [], s=12)
scat_e   = ax_e.scatter([], [], s=12)


for ax in axs.flat:
    ax.set_xlim(-0.4, 0.4)
    ax.set_ylim(0, 1.2)
    ax.grid()

axs.flat[-1].set_ylim(1,2.8)

ax_v.set_ylabel("Velocity [m/s]")
ax_rho.set_ylabel("Density [kg/m³]")
ax_p.set_ylabel("Pressure [N/m²]")
ax_e.set_ylabel("Internal energy [J/kg]")

ax_p.set_xlabel("x [m]")
ax_e.set_xlabel("x [m]")



def update(frame):
    S = sol.y[:, frame].reshape(N, 4)

    system.S[:] = S
    system.density_summation()

    x   = system.x
    v   = system.v
    rho = system.rho
    e   = system.e
    P   = system.pressure()

    scat_v.set_offsets(np.column_stack((x, v)))
    scat_rho.set_offsets(np.column_stack((x, rho)))
    scat_p.set_offsets(np.column_stack((x, P)))
    scat_e.set_offsets(np.column_stack((x, e)))

    fig.suptitle(f"Sod shock tube — t = {sol.t[frame]:.4f}")

    return scat_v, scat_rho, scat_p, scat_e


ani = FuncAnimation(
    fig,
    update,
    frames=len(sol.t),
    interval=50,
    blit=True
)

writer = FFMpegWriter(fps=10, bitrate=1800)
ani.save("./results/sod_all_fields_vs_x.mp4", writer=writer)

